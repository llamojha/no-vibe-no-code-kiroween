# Requirements Document

## Introduction

This document defines the requirements for implementing usage rate limiting for free-tier users in the No Vibe No Code platform. The feature will track and enforce limits on AI-powered analysis report generation to ensure fair resource usage, prevent abuse, and differentiate value between user tiers. The system will integrate with the existing hexagonal architecture and provide clear user feedback when limits are approached or exceeded.

## Glossary

- **Analysis System**: The No Vibe No Code platform component that generates AI-powered startup idea and hackathon project evaluations
- **User Tier**: A classification level assigned to each user (free, paid, or admin) that determines access privileges and resource limits
- **Usage Period**: A fixed time window (daily, weekly, or monthly) during which usage limits are enforced and tracked
- **Rate Limit**: The maximum number of analysis reports a user can generate within a Usage Period
- **Usage Counter**: A numerical value tracking how many analysis reports a user has generated in the current Usage Period
- **Grace Analysis**: The first analysis report generated by a new user, which may be excluded from usage counting
- **Usage Repository**: The data access interface for persisting and retrieving usage tracking information

## Requirements

### Requirement 1: Rate Limit Configuration

**User Story:** As a platform administrator, I want to configure different rate limits for each user tier, so that I can control resource consumption and differentiate service levels.

#### Acceptance Criteria

1. THE Analysis System SHALL enforce a limit of 5 analysis reports per Usage Period for users with User Tier "free"
2. THE Analysis System SHALL allow unlimited analysis reports for users with User Tier "paid"
3. THE Analysis System SHALL allow unlimited analysis reports for users with User Tier "admin"
4. THE Analysis System SHALL reset the Usage Counter at the start of each new Usage Period
5. THE Analysis System SHALL use a daily Usage Period of 24 hours starting at 00:00 UTC

### Requirement 2: Usage Tracking

**User Story:** As a system, I need to accurately track analysis report generation, so that I can enforce rate limits and provide usage statistics.

#### Acceptance Criteria

1. WHEN a user with User Tier "free" generates an analysis report, THE Analysis System SHALL increment the Usage Counter for that user
2. WHEN a user with User Tier "paid" generates an analysis report, THE Analysis System SHALL record the usage event without enforcing limits
3. THE Analysis System SHALL persist usage tracking data with user identifier, timestamp, analysis type, and Usage Period
4. THE Analysis System SHALL retrieve the current Usage Counter for a user within 200 milliseconds
5. WHEN the Usage Period resets, THE Analysis System SHALL set the Usage Counter to zero for all users

### Requirement 3: Rate Limit Enforcement

**User Story:** As a free-tier user, I want to be prevented from generating reports beyond my limit, so that the system maintains fair usage policies.

#### Acceptance Criteria

1. WHEN a user with User Tier "free" attempts to generate an analysis report, THE Analysis System SHALL verify the Usage Counter is below the Rate Limit before processing
2. IF the Usage Counter equals or exceeds the Rate Limit, THEN THE Analysis System SHALL reject the analysis request with HTTP status code 429
3. WHEN rejecting a request due to Rate Limit, THE Analysis System SHALL return an error message stating "Daily analysis limit reached. Upgrade to continue analyzing ideas."
4. THE Analysis System SHALL allow the analysis request to proceed when the Usage Counter is below the Rate Limit
5. THE Analysis System SHALL apply Rate Limit enforcement to both startup idea analysis and hackathon project analysis

### Requirement 4: Usage Information Display

**User Story:** As a free-tier user, I want to see my current usage status, so that I can understand how many analyses I have remaining.

#### Acceptance Criteria

1. WHEN a user with User Tier "free" successfully generates an analysis report, THE Analysis System SHALL return the current Usage Counter in the API response
2. WHEN a user with User Tier "free" successfully generates an analysis report, THE Analysis System SHALL return the Rate Limit value in the API response
3. WHEN a user with User Tier "free" successfully generates an analysis report, THE Analysis System SHALL return the Usage Period reset timestamp in the API response
4. THE Analysis System SHALL format the reset timestamp in ISO 8601 format with UTC timezone
5. WHEN a user with User Tier "paid" or "admin" generates an analysis report, THE Analysis System SHALL return usage information indicating unlimited access

### Requirement 5: Grace Period for New Users

**User Story:** As a new free-tier user, I want my first analysis to not count against my limit, so that I can experience the platform's value before restrictions apply.

#### Acceptance Criteria

1. WHEN a user with User Tier "free" generates their first analysis report ever, THE Analysis System SHALL process the request without incrementing the Usage Counter
2. WHEN a user with User Tier "free" generates their second analysis report, THE Analysis System SHALL increment the Usage Counter to 1
3. THE Analysis System SHALL track whether a user has received the Grace Analysis using a boolean flag in the user profile
4. THE Analysis System SHALL apply the Grace Analysis only once per user account lifetime
5. WHEN a user upgrades from "free" to "paid" tier, THE Analysis System SHALL preserve the Grace Analysis flag without resetting it

### Requirement 6: Database Performance

**User Story:** As a system administrator, I want usage tracking queries to be performant, so that rate limiting does not degrade user experience.

#### Acceptance Criteria

1. THE Usage Repository SHALL use a database index on user identifier and timestamp fields
2. THE Usage Repository SHALL complete usage count queries within 200 milliseconds at the 95th percentile
3. THE Usage Repository SHALL complete usage recording operations within 100 milliseconds at the 95th percentile
4. THE Analysis System SHALL cache the Usage Counter in memory for 60 seconds to reduce database queries
5. WHEN the cached Usage Counter expires, THE Analysis System SHALL refresh the value from the Usage Repository

### Requirement 7: Error Handling and Resilience

**User Story:** As a user, I want the system to handle rate limiting errors gracefully, so that I receive clear feedback and the system remains stable.

#### Acceptance Criteria

1. IF the Usage Repository fails to retrieve usage data, THEN THE Analysis System SHALL allow the analysis request to proceed and log the error
2. IF the Usage Repository fails to record usage data, THEN THE Analysis System SHALL complete the analysis request and log the error
3. WHEN returning a 429 status code, THE Analysis System SHALL include a "Retry-After" header with the seconds until Usage Period reset
4. THE Analysis System SHALL validate that the User Tier value is one of "free", "paid", or "admin" before applying rate limits
5. IF the User Tier value is invalid or missing, THEN THE Analysis System SHALL treat the user as User Tier "free"

### Requirement 8: Upgrade Path Communication

**User Story:** As a free-tier user who has reached my limit, I want to see clear upgrade options, so that I can continue using the platform if I choose to pay.

#### Acceptance Criteria

1. WHEN returning a 429 status code, THE Analysis System SHALL include a response field "upgradeUrl" with the path to the pricing page
2. WHEN returning a 429 status code, THE Analysis System SHALL include a response field "upgradeMessage" stating "Upgrade to paid tier for unlimited analyses"
3. THE Analysis System SHALL include the current User Tier in the error response
4. THE Analysis System SHALL include the Rate Limit value in the error response
5. THE Analysis System SHALL include the Usage Period reset timestamp in the error response
