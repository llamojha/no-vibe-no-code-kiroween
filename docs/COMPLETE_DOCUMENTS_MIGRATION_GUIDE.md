# Complete Documents Migration Guide

## Overview

This guide documents the complete migration from the legacy `saved_analyses` table to the new `ideas` and `documents` table architecture. The migration enables better organization, multiple analyses per idea, and future extensibility.

**Migration Status**: âœ… **Complete**

**Last Updated**: January 2025

## Table of Contents

1. [What Changed](#what-changed)
2. [Why We Migrated](#why-we-migrated)
3. [New Data Model](#new-data-model)
4. [Migration Strategy](#migration-strategy)
5. [Backward Compatibility](#backward-compatibility)
6. [Developer Guide](#developer-guide)
7. [Testing Checklist](#testing-checklist)
8. [Troubleshooting](#troubleshooting)

## What Changed

### Before Migration

**Single Table Architecture**:

```
saved_analyses
â”œâ”€ id (UUID)
â”œâ”€ user_id (UUID)
â”œâ”€ analysis_type (TEXT) - 'idea', 'hackathon', 'frankenstein'
â”œâ”€ idea (TEXT) - The idea/project description
â”œâ”€ analysis (JSONB) - Analysis data
â”œâ”€ audio_base64 (TEXT)
â”œâ”€ created_at (TIMESTAMPTZ)
â””â”€ updated_at (TIMESTAMPTZ)
```

**Limitations**:

- Ideas and analyses were tightly coupled
- No way to have multiple analyses for the same idea
- No project management features (status, notes, tags)
- Difficult to add new document types

### After Migration

**Two-Table Architecture**:

```
ideas
â”œâ”€ id (UUID)
â”œâ”€ user_id (UUID)
â”œâ”€ idea_text (TEXT)
â”œâ”€ source (TEXT) - 'manual' or 'frankenstein'
â”œâ”€ project_status (TEXT) - 'idea', 'in_progress', 'completed', 'archived'
â”œâ”€ notes (TEXT)
â”œâ”€ tags (TEXT[])
â”œâ”€ created_at (TIMESTAMPTZ)
â””â”€ updated_at (TIMESTAMPTZ)

documents
â”œâ”€ id (UUID)
â”œâ”€ idea_id (UUID) â†’ ideas.id
â”œâ”€ user_id (UUID)
â”œâ”€ document_type (TEXT) - 'startup_analysis', 'hackathon_analysis'
â”œâ”€ title (TEXT)
â”œâ”€ content (JSONB)
â”œâ”€ created_at (TIMESTAMPTZ)
â””â”€ updated_at (TIMESTAMPTZ)
```

**Benefits**:

- Ideas exist independently of analyses
- Multiple analyses per idea (e.g., both startup and hackathon)
- Project management features (status tracking, notes, tags)
- Foundation for future document types (PRDs, Design Docs, Roadmaps)
- Better organization and discoverability

## Why We Migrated

### Business Drivers

1. **User Feedback**: Users wanted to track multiple analyses for the same idea
2. **Project Management**: Need for status tracking and organization features
3. **Future Features**: Foundation for generating execution-ready documentation
4. **Better UX**: Dedicated Idea Panel workspace for managing ideas

### Technical Drivers

1. **Separation of Concerns**: Ideas and analyses are distinct domain concepts
2. **Extensibility**: Easy to add new document types without schema changes
3. **Clean Architecture**: Follows domain-driven design principles
4. **Scalability**: Better query performance with proper indexes

## New Data Model

### Ideas Table

Stores all startup ideas and project concepts with management metadata.

**Schema**:

```sql
CREATE TABLE ideas (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  idea_text TEXT NOT NULL,
  source TEXT NOT NULL DEFAULT 'manual'
    CHECK (source IN ('manual', 'frankenstein')),
  project_status TEXT NOT NULL DEFAULT 'idea'
    CHECK (project_status IN ('idea', 'in_progress', 'completed', 'archived')),
  notes TEXT DEFAULT '',
  tags TEXT[] DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**Key Fields**:

- `source`: How the idea was created
  - `'manual'`: User-created via analyzer
  - `'frankenstein'`: Generated by Doctor Frankenstein
- `project_status`: Current workflow status
  - `'idea'`: Initial state
  - `'in_progress'`: Actively working on it
  - `'completed'`: Finished
  - `'archived'`: No longer active
- `notes`: User notes for capturing thoughts and progress
- `tags`: Array of tags for organization

### Documents Table

Stores analyses and future document types linked to ideas.

**Schema**:

```sql
CREATE TABLE documents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  idea_id UUID NOT NULL REFERENCES ideas(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  document_type TEXT NOT NULL
    CHECK (document_type IN ('startup_analysis', 'hackathon_analysis')),
  title TEXT,
  content JSONB NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**Key Fields**:

- `idea_id`: Foreign key linking to parent idea
- `document_type`: Type of document
  - `'startup_analysis'`: Standard startup idea analysis
  - `'hackathon_analysis'`: Hackathon project analysis
  - Future: `'prd'`, `'design_doc'`, `'roadmap'`, `'architecture'`
- `content`: JSONB field containing the analysis or document data

### Relationship Model

```
ideas (1) â†’ (many) documents
  â”œâ”€ startup_analysis documents
  â”œâ”€ hackathon_analysis documents
  â””â”€ future: prd, design_doc, roadmap documents

saved_analyses (LEGACY - read-only for backward compatibility)
```

**Relationship Details**:

- **One-to-Many**: One idea can have multiple documents
- **Foreign Key**: `documents.idea_id` â†’ `ideas.id` (CASCADE DELETE)
- **Orphaned Ideas**: Ideas can exist without documents (e.g., Doctor Frankenstein ideas)

## Migration Strategy

### Phase 1: Idea Panel MVP (Completed)

**Goal**: Create new tables and Idea Panel UI

**Changes**:

- Created `ideas` and `documents` tables
- Implemented Idea Panel UI components
- Added API endpoints for idea management
- Migrated existing data from `saved_analyses` to new tables

**Status**: âœ… Complete

### Phase 2: Complete Migration (Completed)

**Goal**: Update all save/load/update/delete operations to use new tables

**Changes**:

- Updated `saveAnalysis()` to create idea + document
- Updated `saveHackathonAnalysis()` to create idea + document
- Updated `saveFrankensteinIdea()` to create idea only
- Updated load operations with fallback to `saved_analyses`
- Updated update operations with fallback to `saved_analyses`
- Updated delete operations with fallback to `saved_analyses`
- Updated dashboard to show ideas instead of analyses

**Status**: âœ… Complete

### Phase 3: Gradual Adoption (Current)

**Goal**: All new data uses new tables, legacy data remains accessible

**Behavior**:

- **New Analyses**: Save to `ideas` + `documents` tables
- **Legacy Analyses**: Remain in `saved_analyses`, accessible via fallback
- **No Forced Migration**: Users don't need to migrate legacy data
- **Seamless UX**: Users see mix of old and new data without noticing

**Status**: âœ… Active

### Phase 4: Optional Data Migration (Future)

**Goal**: Provide tool for users to migrate legacy analyses

**Planned Features**:

- Admin tool to migrate specific analyses
- Bulk migration option for power users
- Verification and rollback capabilities
- Progress tracking and error handling

**Status**: ðŸ“‹ Planned

## Backward Compatibility

### Read Operations

All read operations implement fallback logic:

```typescript
async function loadAnalysis(id: string) {
  // Try new tables first
  const document = await documentRepository.findById(id);
  if (document) {
    return document;
  }

  // Fallback to legacy table
  const legacyAnalysis = await legacyRepository.findById(id);
  if (legacyAnalysis) {
    return legacyAnalysis;
  }

  // Not found anywhere
  throw new NotFoundError("Analysis not found");
}
```

### Write Operations

All new writes go to new tables:

```typescript
async function saveAnalysis(params: SaveAnalysisParams) {
  // Create or load idea
  const idea = params.ideaId
    ? await ideaRepository.findById(params.ideaId)
    : await ideaRepository.save(
        new Idea({
          ideaText: params.idea,
          source: "manual",
        })
      );

  // Create document linked to idea
  const document = await documentRepository.save(
    new Document({
      ideaId: idea.id,
      documentType: "startup_analysis",
      content: params.analysis,
    })
  );

  return { ideaId: idea.id, documentId: document.id };
}
```

### Update/Delete Operations

Update and delete operations try new tables first, then fallback:

```typescript
async function deleteAnalysis(id: string) {
  // Try deleting from documents table
  const deleted = await documentRepository.delete(id);
  if (deleted) {
    return { success: true };
  }

  // Fallback to legacy table
  const legacyDeleted = await legacyRepository.delete(id);
  if (legacyDeleted) {
    return { success: true };
  }

  throw new NotFoundError("Analysis not found");
}
```

### No Breaking Changes

The migration was designed to be non-breaking:

- âœ… All existing API endpoints continue to work
- âœ… All existing UI components continue to work
- âœ… Legacy data remains accessible
- âœ… No forced data migration required
- âœ… No downtime during migration

## Developer Guide

### Creating New Analyses

**Startup Analysis**:

```typescript
import { saveAnalysis } from "@/features/analyzer/api/saveAnalysis";

const result = await saveAnalysis({
  idea: "My startup idea",
  analysis: {
    score: 78,
    detailedSummary: "...",
    criteria: [...],
  },
  ideaId: optionalExistingIdeaId, // Link to existing idea
});

// Returns: { ideaId, documentId, createdAt }
```

**Hackathon Analysis**:

```typescript
import { saveHackathonAnalysis } from "@/features/kiroween-analyzer/api/saveHackathonAnalysis";

const result = await saveHackathonAnalysis({
  projectDescription: "My hackathon project",
  analysis: {
    score: 82,
    detailedSummary: "...",
    criteria: [...],
    selectedCategory: "frankenstein",
  },
  ideaId: optionalExistingIdeaId, // Link to existing idea
});

// Returns: { ideaId, documentId, createdAt }
```

**Doctor Frankenstein Idea**:

```typescript
import { saveFrankensteinIdea } from "@/features/doctor-frankenstein/api/saveFrankensteinIdea";

const result = await saveFrankensteinIdea({
  idea: "Generated mashup idea",
  frankensteinMode: "tech",
  slot1: "Stripe",
  slot2: "Notion",
  slot3: "Figma",
});

// Returns: { ideaId, createdAt }
// Note: No document created yet
```

### Loading Analyses

**Load Single Analysis**:

```typescript
import { loadAnalysis } from "@/features/analyzer/api/loadAnalysis";

const analysis = await loadAnalysis(analysisId);
// Automatically tries documents table first, then saved_analyses
```

**Load Idea with All Documents**:

```typescript
import { getIdeaWithDocuments } from "@/features/idea-panel/api/getIdeaWithDocuments";

const { idea, documents } = await getIdeaWithDocuments(ideaId);
// Returns idea with all associated documents
```

**Load All Ideas for User**:

```typescript
import { getUserIdeas } from "@/features/idea-panel/api/getUserIdeas";

const ideas = await getUserIdeas();
// Returns all ideas with document counts
```

### URL Parameter Conventions

When navigating between features with `ideaId`:

```typescript
// Navigate to analyzer with existing idea
router.push(`/analyzer?ideaId=${ideaId}`);

// Navigate to hackathon analyzer with existing idea
router.push(`/kiroween-analyzer?ideaId=${ideaId}`);

// Navigate to Idea Panel
router.push(`/idea/${ideaId}`);
```

**Reading ideaId in Components**:

```typescript
import { useSearchParams } from "next/navigation";

const searchParams = useSearchParams();
const ideaId = searchParams.get("ideaId");

// Pass to save function if present
await saveAnalysis({ idea, analysis, ideaId });
```

### Repository Usage

**IdeaRepository**:

```typescript
import { IdeaRepository } from "@/src/infrastructure/database/supabase/repositories/SupabaseIdeaRepository";

// Save idea
const idea = await ideaRepository.save(
  new Idea({
    ideaText: "My idea",
    source: "manual",
    projectStatus: "idea",
  })
);

// Find by ID
const idea = await ideaRepository.findById(ideaId);

// Find all for user
const ideas = await ideaRepository.findByUserId(userId);
```

**DocumentRepository**:

```typescript
import { DocumentRepository } from "@/src/infrastructure/database/supabase/repositories/SupabaseDocumentRepository";

// Save document
const document = await documentRepository.save(
  new Document({
    ideaId: idea.id,
    documentType: "startup_analysis",
    content: analysisData,
  })
);

// Find by ID
const document = await documentRepository.findById(documentId);

// Find all for idea
const documents = await documentRepository.findByIdeaId(ideaId);
```

## Testing Checklist

### Unit Tests

- [x] IdeaRepository save/find operations
- [x] DocumentRepository save/find operations
- [x] saveAnalysis with and without ideaId
- [x] saveHackathonAnalysis with and without ideaId
- [x] saveFrankensteinIdea
- [x] Load operations with fallback logic
- [x] Update operations with fallback logic
- [x] Delete operations with fallback logic

### Integration Tests

- [x] Complete startup analysis flow
- [x] Complete hackathon analysis flow
- [x] Doctor Frankenstein flow
- [x] Idea Panel flow
- [x] Legacy data compatibility
- [x] Dashboard displays ideas correctly
- [x] Multiple analyses per idea

### E2E Tests

- [x] Create startup analysis
- [x] Create hackathon analysis
- [x] Generate Frankenstein idea
- [x] Analyze Frankenstein idea
- [x] View analysis from dashboard
- [x] View legacy analysis
- [x] Navigate to Idea Panel
- [x] Update idea status
- [x] Add notes and tags

### Manual Testing

- [x] Create analysis without ideaId
- [x] Create analysis with ideaId
- [x] Generate Frankenstein idea
- [x] Analyze Frankenstein idea
- [x] View dashboard
- [x] Open Idea Panel
- [x] Update analysis
- [x] Delete analysis
- [x] Test with legacy data
- [x] Verify RLS policies
- [x] Test with different users

## Troubleshooting

### Common Issues

#### Issue: Analysis not saving

**Symptoms**: Save operation fails with error

**Possible Causes**:

1. Invalid ideaId provided
2. Database constraint violation
3. RLS policy blocking access

**Solutions**:

```typescript
// Check if ideaId exists
const idea = await ideaRepository.findById(ideaId);
if (!idea) {
  throw new Error("Invalid ideaId");
}

// Verify user owns the idea
if (idea.userId !== currentUserId) {
  throw new Error("Unauthorized");
}
```

#### Issue: Legacy analysis not loading

**Symptoms**: Analysis exists in `saved_analyses` but not loading

**Possible Causes**:

1. Fallback logic not working
2. RLS policy blocking access
3. Analysis ID mismatch

**Solutions**:

```typescript
// Verify fallback logic is implemented
async function loadAnalysis(id: string) {
  // Try new tables first
  const document = await documentRepository.findById(id);
  if (document) return document;

  // IMPORTANT: Fallback to legacy table
  const legacyAnalysis = await legacyRepository.findById(id);
  if (legacyAnalysis) return legacyAnalysis;

  throw new NotFoundError("Analysis not found");
}
```

#### Issue: Orphaned ideas

**Symptoms**: Ideas exist without documents

**Expected Behavior**: This is normal for Doctor Frankenstein ideas

**Solutions**:

- Orphaned ideas are valid state
- Doctor Frankenstein creates ideas without documents intentionally
- Users can analyze them later from Idea Panel

#### Issue: Dashboard not showing ideas

**Symptoms**: Dashboard empty or showing wrong data

**Possible Causes**:

1. Dashboard still using old API
2. Query not joining with documents table
3. RLS policy issue

**Solutions**:

```typescript
// Verify dashboard uses getUserIdeas()
import { getUserIdeas } from "@/features/idea-panel/api/getUserIdeas";

const ideas = await getUserIdeas();
// Should return ideas with document counts
```

### Database Queries for Debugging

**Check idea and document counts**:

```sql
SELECT
  (SELECT COUNT(*) FROM ideas WHERE user_id = '<user-id>') as idea_count,
  (SELECT COUNT(*) FROM documents WHERE user_id = '<user-id>') as document_count,
  (SELECT COUNT(*) FROM saved_analyses WHERE user_id = '<user-id>') as legacy_count;
```

**Find orphaned ideas**:

```sql
SELECT i.*
FROM ideas i
LEFT JOIN documents d ON d.idea_id = i.id
WHERE i.user_id = '<user-id>'
  AND d.id IS NULL;
```

**Find ideas with multiple documents**:

```sql
SELECT
  i.id,
  i.idea_text,
  COUNT(d.id) as document_count
FROM ideas i
LEFT JOIN documents d ON d.idea_id = i.id
WHERE i.user_id = '<user-id>'
GROUP BY i.id
HAVING COUNT(d.id) > 1;
```

### Logging and Monitoring

**Enable debug logging**:

```typescript
// In repository implementations
console.log("[IdeaRepository] Saving idea:", idea);
console.log("[DocumentRepository] Saving document:", document);
console.log("[LegacyRepository] Fallback to saved_analyses");
```

**Monitor query performance**:

```sql
-- Check slow queries
SELECT
  query,
  calls,
  total_time,
  mean_time
FROM pg_stat_statements
WHERE query LIKE '%ideas%' OR query LIKE '%documents%'
ORDER BY mean_time DESC
LIMIT 10;
```

## Related Documentation

- [Architecture Documentation](./ARCHITECTURE.md)
- [API Documentation](./API.md)
- [Database Schema](./DATABASE_SCHEMA.md)
- [Idea Panel User Guide](./IDEA_PANEL_USER_GUIDE.md)
- [Idea Panel API](./IDEA_PANEL_API.md)
- [Idea Panel Migration](./IDEA_PANEL_MIGRATION.md)
- [Developer Guide](./DEVELOPER_GUIDE.md)

## Changelog

### January 2025 - Complete Migration

- âœ… Updated all save operations to use new tables
- âœ… Updated all load operations with fallback logic
- âœ… Updated all update operations with fallback logic
- âœ… Updated all delete operations with fallback logic
- âœ… Updated dashboard to show ideas
- âœ… Verified backward compatibility
- âœ… Completed all tests
- âœ… Updated documentation

### December 2024 - Idea Panel MVP

- âœ… Created `ideas` and `documents` tables
- âœ… Implemented Idea Panel UI
- âœ… Added API endpoints
- âœ… Migrated existing data
- âœ… Verified RLS policies

## Support

For questions or issues related to the migration:

1. Check this guide first
2. Review related documentation
3. Check database logs and query performance
4. Verify RLS policies are working
5. Test with different users to isolate issues

---

**Last Updated**: January 2025
**Migration Status**: âœ… Complete
**Backward Compatibility**: âœ… Maintained
