name: Property Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  property-tests:
    name: Property-Based Tests with Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Record start time
        id: start-time
        run: echo "start=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run property tests with coverage
        id: run-tests
        run: npm run test:properties:coverage
        env:
          CI: true

      - name: Check property test results
        id: test-check
        if: always()
        run: |
          if [ -f tests/property-coverage-report.json ]; then
            node -e "
              const fs = require('fs');
              const report = JSON.parse(fs.readFileSync('tests/property-coverage-report.json', 'utf8'));

              // Access nested coverage fields
              const coverage = report.coverage || {};
              const tested = coverage.tested || 0;
              const total = coverage.total || 0;
              const percentage = coverage.percentage || 0;

              console.log('Property Coverage:', tested + '/' + total);
              console.log('Percentage:', percentage.toFixed(1) + '%');

              // Write to GITHUB_OUTPUT
              const output = 'tested=' + tested + '\n' +
                            'total=' + total + '\n' +
                            'percentage=' + percentage.toFixed(1) + '\n';
              fs.appendFileSync(process.env.GITHUB_OUTPUT, output);

              // Add to step summary
              let summary = '### Property Test Coverage\n\n';
              summary += '- **Total Properties:** ' + total + '\n';
              summary += '- **Tested Properties:** ' + tested + '\n';
              summary += '- **Coverage:** ' + percentage.toFixed(1) + '%\n\n';

              // Show coverage by category
              if (coverage.byCategory) {
                summary += '#### Coverage by Category\n\n';
                for (const [category, stats] of Object.entries(coverage.byCategory)) {
                  const pct = stats.total > 0 ? ((stats.tested / stats.total) * 100).toFixed(1) : '0.0';
                  summary += '- **' + category + ':** ' + stats.tested + '/' + stats.total + ' (' + pct + '%)\n';
                }
                summary += '\n';
              }

              if (report.untested && report.untested.length > 0) {
                summary += '#### ⚠️ Untested Properties (' + report.untested.length + ')\n\n';
                report.untested.slice(0, 10).forEach(prop => {
                  summary += '- ' + prop.id + ': ' + prop.name + '\n';
                });
                if (report.untested.length > 10) {
                  summary += '\n_...and ' + (report.untested.length - 10) + ' more_\n';
                }
              } else {
                summary += '✅ All properties have tests!\n';
              }

              fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, summary);
            "
          else
            echo "⚠️ Property coverage report not found"
            echo "tested=0" >> $GITHUB_OUTPUT
            echo "total=0" >> $GITHUB_OUTPUT
            echo "percentage=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload property coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: property-coverage-report-${{ github.run_number }}
          path: |
            tests/property-coverage-report.json
            coverage/
          retention-days: 30
          if-no-files-found: warn

      - name: Calculate workflow duration
        if: always()
        run: |
          START_TIME=${{ steps.start-time.outputs.start }}
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          DURATION_MIN=$((DURATION / 60))
          DURATION_SEC=$((DURATION % 60))

          echo "duration_seconds=$DURATION" >> $GITHUB_OUTPUT
          echo "### ⏱️ Workflow Duration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Total time: ${DURATION_MIN}m ${DURATION_SEC}s" >> $GITHUB_STEP_SUMMARY

          # Log warning if duration exceeds 5 minutes (property tests should be fast)
          if [ $DURATION -gt 300 ]; then
            echo "::warning::Property tests exceeded 5 minute threshold (${DURATION_MIN}m ${DURATION_SEC}s)"
            echo "⚠️ Duration exceeded 5 minute threshold" >> $GITHUB_STEP_SUMMARY
          fi

          # Save duration for PR comment
          echo "{\"workflow\":\"property-tests\",\"duration_seconds\":$DURATION,\"duration_formatted\":\"${DURATION_MIN}m ${DURATION_SEC}s\"}" > workflow-duration.json

      - name: Upload duration metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: duration-property-tests-${{ github.run_number }}
          path: workflow-duration.json
          retention-days: 30
          if-no-files-found: warn
