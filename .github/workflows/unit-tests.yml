name: Unit Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  unit-tests:
    name: Vitest Unit Tests with Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Record start time
        id: start-time
        run: echo "start=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests with coverage
        run: npm run test:coverage -- --reporter=json --outputFile=test-results.json
        continue-on-error: true
        env:
          CI: true

      - name: Check coverage threshold
        id: coverage-check
        if: always()
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(node -e "
              const fs = require('fs');
              const summary = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
              const pct = summary.total.lines.pct;
              console.log(pct);
            ")

            echo "coverage_pct=$COVERAGE" >> $GITHUB_OUTPUT

            echo "### Coverage Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Overall Coverage: ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
            echo "- Threshold: 70%" >> $GITHUB_STEP_SUMMARY

            if (( $(echo "$COVERAGE < 70" | bc -l) )); then
              echo "::warning::Coverage is below 70% ($COVERAGE%)"
              echo "- Status: ⚠️ Below threshold" >> $GITHUB_STEP_SUMMARY
            else
              echo "✅ Coverage meets threshold"
              echo "- Status: ✅ Meets threshold" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "⚠️ Coverage summary not found"
            echo "coverage_pct=0" >> $GITHUB_OUTPUT
          fi

      - name: Parse test results
        id: test-check
        if: always()
        run: |
          if [ -f test-results.json ]; then
            node -e "
              const fs = require('fs');
              const results = JSON.parse(fs.readFileSync('test-results.json', 'utf8'));

              const numTotal = results.numTotalTests || 0;
              const numPassed = results.numPassedTests || 0;
              const numFailed = results.numFailedTests || 0;

              console.log('Total tests:', numTotal);
              console.log('Passed:', numPassed);
              console.log('Failed:', numFailed);

              if (numFailed > 0) {
                console.error('❌ ' + numFailed + ' test(s) failed');
                process.exit(1);
              } else {
                console.log('✅ All tests passed');
                process.exit(0);
              }
            "
          else
            echo "❌ Test results file not found"
            exit 1
          fi

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-${{ github.run_number }}
          path: |
            coverage/
          retention-days: 30
          if-no-files-found: warn

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results-${{ github.run_number }}
          path: |
            test-results.json
          retention-days: 30
          if-no-files-found: warn

      - name: Calculate workflow duration
        if: always()
        run: |
          START_TIME=${{ steps.start-time.outputs.start }}
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          DURATION_MIN=$((DURATION / 60))
          DURATION_SEC=$((DURATION % 60))

          echo "duration_seconds=$DURATION" >> $GITHUB_OUTPUT
          echo "### ⏱️ Workflow Duration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Total time: ${DURATION_MIN}m ${DURATION_SEC}s" >> $GITHUB_STEP_SUMMARY

          # Log warning if duration exceeds 15 minutes
          if [ $DURATION -gt 900 ]; then
            echo "::warning::Workflow duration exceeded 15 minutes (${DURATION_MIN}m ${DURATION_SEC}s)"
            echo "⚠️ Duration exceeded 15 minute threshold" >> $GITHUB_STEP_SUMMARY
          fi

          # Save duration for PR comment
          echo "{\"workflow\":\"unit-tests\",\"duration_seconds\":$DURATION,\"duration_formatted\":\"${DURATION_MIN}m ${DURATION_SEC}s\"}" > workflow-duration.json

      - name: Upload duration metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: duration-unit-tests-${{ github.run_number }}
          path: workflow-duration.json
          retention-days: 30
          if-no-files-found: warn
